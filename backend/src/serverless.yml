org: brunogarcial
service: pardos-orders

provider:
  name: aws
  runtime: python3.13
  memorySize: 1024
  timeout: 20
  iam:
    role: arn:aws:iam::663025695161:role/LabRole   # mismo estilo que tu ejemplo
  environment:
    TENANTS_TABLE: ${sls:stage}-Tenants
    MENU_TABLE: ${sls:stage}-MenuItems
    ORDERS_TABLE: ${sls:stage}-Orders
    ORDER_EVENTS_TABLE: ${sls:stage}-OrderEvents
    EVENTS_BUS_NAME: ${sls:stage}-pardos-orders-bus
    REPORTS_BUCKET: ${sls:stage}-pardos-orders-reports

functions:
  # -------- MS TENANTS & MENU --------
  getTenants:
    handler: src/ms_tenants_menu/get_tenants.handler
    events:
      - httpApi:
          path: /tenants
          method: get

  getMenu:
    handler: src/ms_tenants_menu/get_menu.handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu
          method: get

  putMenuItem:
    handler: src/ms_tenants_menu/put_menu_item.handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/menu
          method: post

  # -------- MS ORDERS (CLIENTE) --------
  createOrder:
    handler: src/ms_orders/create_order.handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders
          method: post

  getOrder:
    handler: src/ms_orders/get_order.handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}
          method: get

  listOrders:
    handler: src/ms_orders/list_orders.handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders
          method: get

  # -------- MS WORKFLOW (RESTAURANTE) --------
  updateOrderStep:
    handler: src/ms_workflow/update_order_step.handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/orders/{orderId}/step
          method: post

  getDashboardSummary:
    handler: src/ms_workflow/get_dashboard_summary.handler
    events:
      - httpApi:
          path: /tenants/{tenantId}/dashboard
          method: get

  # Exportador diario a S3 (reportes)
  exportDailyReport:
    handler: src/ms_workflow/export_daily_report.handler
    events:
      - schedule:
          rate: rate(1 day)
          enabled: true

resources:
  Resources:
    # ---------- DynamoDB ----------
    TenantsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.TENANTS_TABLE}
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

    MenuTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.MENU_TABLE}
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: product_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: product_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDERS_TABLE}
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: order_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: order_id
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    OrderEventsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ORDER_EVENTS_TABLE}
        AttributeDefinitions:
          - AttributeName: order_id
            AttributeType: S
          - AttributeName: ts
            AttributeType: S
        KeySchema:
          - AttributeName: order_id
            KeyType: HASH
          - AttributeName: ts
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

    # ---------- EventBridge ----------
    OrdersEventBus:
      Type: AWS::Events::EventBus
      Properties:
        Name: ${self:provider.environment.EVENTS_BUS_NAME}

    # ---------- S3 para reportes ----------
    ReportsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.REPORTS_BUCKET}

    # ---------- Step Functions (workflow simple) ----------
    OrderWorkflowStateMachine:
      Type: AWS::StepFunctions::StateMachine
      Properties:
        StateMachineName: ${sls:stage}-pardos-order-workflow
        StateMachineType: STANDARD
        RoleArn: arn:aws:iam::663025695161:role/LabRole
        DefinitionString: |
          {
            "Comment": "Simple workflow de pedidos Pardos Chicken",
            "StartAt": "MarkReceived",
            "States": {
              "MarkReceived": {
                "Type": "Pass",
                "Next": "WaitCooking"
              },
              "WaitCooking": {
                "Type": "Wait",
                "Seconds": 60,
                "Next": "WaitPacking"
              },
              "WaitPacking": {
                "Type": "Wait",
                "Seconds": 60,
                "Next": "WaitDelivering"
              },
              "WaitDelivering": {
                "Type": "Wait",
                "Seconds": 60,
                "Next": "Done"
              },
              "Done": {
                "Type": "Succeed"
              }
            }
          }
